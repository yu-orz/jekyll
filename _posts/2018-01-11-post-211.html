---
layout: post
title: Amazon EchoとRaspberry Piで家電を操作してみた - 赤外線モジュール編
date: 2018-01-11 23:04:46.000000000 +09:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Linux
- ハードウェア
tags: []
meta:
  _wpcom_is_markdown: '1'
  _edit_last: '1'
  is_comment_form_freeze: ''
  comment_form_freeze_message: ''
  is_ads_removed_in_page: ''
  seo_title: ''
  meta_description: ''
  meta_keywords: ''
  is_noindex: ''
  is_nofollow: ''
  page_type: default
  is_noamp: ''
  update_level: high
author:
  login: yuki
  email: yuki@yu-orz.info
  display_name: ぴーやま
  first_name: ''
  last_name: ''
---
<h2>tl;dr</h2>
<ul>
<li>Raspberry Piに<a href="https://www.amazon.co.jp/dp/B013JG0WSG" rel="noopener" target="_blank">USB赤外線リモコンアドバンス</a>を接続する</li>
<li>CLIをインストールする</li>
<li>シェル書く</li>
<li>叩く</li>
</ul>
<h2>環境</h2>
<ul>
<li>Raspberry Pi 2 Model B</li>
<li>Raspbian 8.0</li>
</ul>
<h2>手順</h2>
<h3>つなげる</h3>
<p>USB赤外線リモコンアドバンスはつなげるだけで認識するようです。</p>
<pre>
 $ dmesg |grep "USB IR"
[    2.861873] usb 1-1.5.3: Product: USB IR Remote controller Advance
[    2.871373] input: Bit Trade One, LTD.  USB IR Remote controller Advance as /devices/platform/soc/3f980000.usb/usb1/1-1/1-1.5/1-1.5.3/1-1.5.3:1.0/0003:22EA:003A.0003/input/input1
[    2.878736] hid-generic 0003:22EA:003A.0003: input,hidraw2: USB HID v1.11 Mouse [Bit Trade One, LTD.  USB IR Remote controller Advance] on usb-3f980000.usb-1.5.3/input0
</pre>
<h3>CLIのインストール</h3>
<p>公式にWindows用のツールはありますが、Linuxで使うにはこちらを使います。<br />
<a href="http://a-desk.jp/modules/mydownloads/singlefile.php?cid=3&lid=76" rel="noopener" target="_blank">USB赤外線リモコンアドバンス・UNIX系環境用コマンドライン操作ツール＆GUI操作ツール Ver1.0.0</a></p>
<p>コンパイル時にlibusbが必要になるので前もって入れときます。</p>
<pre>
$ sudo apt-get install libusb-1.0
</pre>
<p>その後、展開してmakeします。</p>
<pre>
$ cd /usr/local/src
$ unzip bto_advanced_USBIR_cmd.zip
$ make
</pre>
<p>出来上がった<code>bto_advanced_USBIR_cmd</code>をPATHの通ったとこに移動します。</p>
<pre>
$ mv bto_advanced_USBIR_cmd /usr/local/bin/.
</pre>
<h3>シェルでラップする</h3>
<p>赤外線の送受信はREADMEにある通り</p>
<pre>
## 受信
$ bto_advanced_USBIR_cmd -r # (生データ)受信開始
$ bto_advanced_USBIR_cmd -s # (生データ)受信停止
$ bto_advanced_USBIR_cmd -g | tee data.txt # 生データ取得

## 送信
$ bto_advanced_USBIR_cmd -d `cat data.txt`
</pre>
<p>なのですが、使いやすいようにシェルでラップします。</p>
<h4>get_ir.sh (受信と生データの書き出し)</h4>
<p>コマンドの引数に名前を取り、取得したデータを適当なディレクトリに${名前}.datとして保存します。</p>
<pre>
#!/bin/bash

NAME=$1
COMM="bto_advanced_USBIR_cmd"

if [ "x${NAME}" == "x" ]; then
  echo "$0 name"
  exit 1
fi

echo "input"
${COMM} -r
read
echo "stop"
${COMM} -s
sleep 0.5
${COMM} -g | tee /usr/local/ir/etc/${NAME}.dat
</pre>
<h4>ir.sh (データの送信)</h4>
<p>引数に名前を取り、get_ir.shで保存したデータを送信します。</p>
<pre>
#!/bin/bash

COMM=$1
FILE_BASE="/usr/local/ir/etc"

bto_advanced_USBIR_cmd -d `cat ${FILE_BASE}/${COMM}.dat`
RC=$?

if [ $RC -eq 0 ]; then
  echo "SUCCESS"
else
  echo "ERROR"
fi
</pre>
<h3>実際にやってみる</h3>
<h4>赤外線の受信とデータの格納</h4>
<pre>
$ ./get_ir.sh aircon_on
input
受信を開始しました。

# ここでリモコンのボタンを押して赤外線を出す
# 押したらEnterを押して終わる

stop
受信を停止しました。
取得したbyte配列の要素数:340
0x00,0x86,0x00,0x42,0x00,0x13,0x00,0x10,0x00,0x13,0x00,0x10,0x00,0x13,0x00,0x32,0x00,0x12,0x00,0x32,0x00,0x12,0x00,0x11,0x00,0x12,0x00,0x32,0x00,0x13,0x00,0x10,0x00,0x12,0x00,0x10,0x00,0x13,0x00,0x11,0x00,0x12,0x00,0x32,0x00,0x12,0x00,0x11,0x00,0x12,0x00,0x11,0x00,0x13,0x00,0x31,0x00,0x13,0x00,0x10,0x00,0x13,0x00,0x32,0x00,0x12,0x00,0x11,0x00,0x12,0x00,0x2f,0x00,0x15,0x00,0x11,0x00,0x13,0x00,0x10,0x00,0x13,0x00,0x31,0x00,0x13,0x00,0x11,0x00,0x12,0x00,0x11,0x00,0x12,0x00,0x11,0x00,0x12,0x00,0x11,0x00,0x12,0x00,0x32,0x00,0x13,0x00,0x31,0x00,0x13,0x00,0x11,0x00,0x12,0x00,0x32,0x00,0x12,0x00,0x11,0x00,0x12,0x00,0x32,0x00,0x13,0x00,0x10,0x00,0x13,0x00,0x10,0x00,0x13,0x00,0x10,0x00,0x13,0x00,0x32,0x00,0x12,0x00,0x11,0x00,0x12,0x00,0x11,0x00,0x13,0x00,0x10,0x00,0x13,0x00,0x31,0x00,0x13,0x00,0x10,0x00,0x13,0x00,0x11,0x00,0x12,0x7f,0xff,0x00,0x00,0x40,0x36,0x00,0x84,0x00,0x45,0x00,0x10,0x00,0x12,0x00,0x12,0x00,0x11,0x00,0x11,0x00,0x34,0x00,0x11,0x00,0x32,0x00,0x11,0x00,0x13,0x00,0x0f,0x00,0x36,0x00,0x10,0x00,0x13,0x00,0x10,0x00,0x13,0x00,0x10,0x00,0x12,0x00,0x13,0x00,0x32,0x00,0x10,0x00,0x13,0x00,0x10,0x00,0x13,0x00,0x10,0x00,0x35,0x00,0x10,0x00,0x13,0x00,0x10,0x00,0x33,0x00,0x11,0x00,0x12,0x00,0x11,0x00,0x34,0x00,0x11,0x00,0x12,0x00,0x11,0x00,0x12,0x00,0x12,0x00,0x32,0x00,0x13,0x00,0x11,0x00,0x10,0x00,0x13,0x00,0x10,0x00,0x13,0x00,0x10,0x00,0x13,0x00,0x0f,0x00,0x14,0x00,0x11,0x00,0x34,0x00,0x11,0x00,0x11,0x00,0x11,0x00,0x33,0x00,0x12,0x00,0x11,0x00,0x12,0x00,0x33,0x00,0x11,0x00,0x12,0x00,0x10,0x00,0x13,0x00,0x11,0x00,0x33,0x00,0x12,0x00,0x33,0x00,0x10,0x00,0x12,0x00,0x12,0x00,0x12,0x00,0x10,0x00,0x13,0x00,0x11,0x00,0x34,0x00,0x10,0x00,0x13,0x00,0x10,0x00,0x13,0x00,0x10,0x0b,0x12
</pre>
<p>これでaircon_on.datというファイルができてきます。</p>
<h4>赤外線の発射</h4>
<pre>
# ./ir.sh aircon_on
SUCCESS
</pre>
<p>次回はHomebridgeを使ってiPhoneとAmazon Echoから操作できるようにしてみたいと思います。</p>
